<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <title>ì™¸ê³„ì¸ í‚¤ìš°ê¸° (ìˆ˜ì •ë³¸)</title>
    <style>
        /* --- ê¸°ë³¸ --- */
        :root{
            --bg:#ff21b5;
            --panel:#000000;
            --accent:#37f137;
            --muted:#ffffff;
            --text:#37f137;
            --danger:#ff1900;
        }
        html,body{
            height:100%;
            margin:0;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }
        body{
            display:flex;
            align-items:center;
            justify-content:center;
            background:var(--bg);
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            color:var(--text);
            user-select:none;
            -webkit-tap-highlight-color: transparent;
            padding:20px;
        }

        /* --- ê²Œì„ ì»¨í…Œì´ë„ˆ --- */
        #game-container{
            width:95%;
            max-width:450px;
            height:85vh;
            min-height:600px;
            background:var(--panel);
            border-radius:20px;
            border:8px solid var(--accent);
            box-shadow:0 16px 30px rgba(0,0,0,0.55);
            position:relative;
            overflow:hidden;
        }

        /* --- ìƒë‹¨ ìŠ¤íƒ¯ ë°” --- */
        #stats-bar{
            position:absolute;
            top:16px;
            left:16px;
            right:16px;
            display:flex;
            justify-content:space-between;
            gap:10px;
            z-index:1200; /* ìµœìƒë‹¨ */
        }
        .stat{ width:32%; text-align:center; }
        .stat-name{ font-size:0.9rem; color:#bdc3c7; margin-bottom:6px; }
        .stat-bar-container{ height:10px; background:#555; border-radius:6px; overflow:hidden; }
        .stat-bar{ height:100%; transition:width .35s ease, background-color .35s; }

        /* --- ì¤‘ì•™ ìºë¦­í„° ì˜ì—­ (ë°˜ì‘í˜• ì¤‘ì•™ ë°°ì¹˜) --- */
        #character-area{
            position:absolute;
            left:50%;
            top:50%;
            transform:translate(-50%,-50%);
            text-align:center;
            width:92%;
            max-width:360px;
            z-index:1300; /* episode-screen ë³´ë‹¤ ìœ„(ê¹¨ì§ ë°©ì§€) */
            pointer-events:none; /* ê¸°ë³¸ì ìœ¼ë¡œ ë¶€ëª¨ ì˜¤ë²„ë ˆì´ í´ë¦­ ë°©í•´í•˜ì§€ ì•Šë„ë¡ none (ê°œë³„ ìš”ì†Œì—ì„œ í™œì„±í™”) */
        }
        #current-message{
            min-height:1.4em;
            font-weight:700;
            margin-bottom:12px;
            font-size:clamp(14px,2.6vw,18px);
            color:var(--text);
        }
        #alien-character{
            font-size:clamp(48px,14vw,120px);
            margin:12px 0;
            display:none;
            cursor:pointer;
            transition:transform .08s ease;
            -webkit-user-select:none;
            user-select:none;
            position:relative; /* z-index ì‘ë™ ìœ„í•´ ìœ„ì¹˜ ì§€ì • */
            z-index:1301;
            pointer-events:auto; /* í´ë¦­ ê°€ëŠ¥ */
            touch-action:manipulation;
            min-height:80px;
            line-height:1;
        }
        .evolution-2{ font-size: clamp(96px, 28vw, 200px) !important; }

        #click-counter{ font-size:clamp(12px,1.8vw,14px); color:#bdc3c7; margin-top:8px; }

        /* --- ì•¡ì…˜ ë²„íŠ¼ --- */
        #action-buttons{
            position:absolute;
            bottom:18px;
            left:50%;
            transform:translateX(-50%);
            width:92%;
            display:flex;
            justify-content:space-between;
            gap:10px;
            z-index:1200;
        }
        .action-button{
            flex:1;
            padding:12px 10px;
            font-size:clamp(13px,2.4vw,16px);
            border-radius:10px;
            border:none;
            cursor:pointer;
            background:#1abc9c;
            color:#fff;
            pointer-events:auto;
        }
        .action-button:disabled{ background:#7f8c8d; cursor:not-allowed; }

        /* --- ì˜¤ë²„ë ˆì´ í™”ë©´ë“¤ (start / episode / ending / gameover) --- */
        .overlay {
            position:absolute;
            inset:0;
            display:flex;
            align-items:center;
            justify-content:center;
            flex-direction:column;
            text-align:center;
            padding:24px;
            background-color:rgba(0,0,0,0.95);
            z-index:1000; /* ë‚®ê²Œ ë‘  -> ìºë¦­í„°ê°€ ìœ„ë¡œ ë‚˜ì˜¤ê²Œ */
            transition:opacity .2s;
        }
        .overlay.hidden{ display:none; }

        #start-screen h1{ font-size:clamp(22px,5.2vw,36px); color:#ff21b5; margin:10px 0; }
        .start-button{
            padding:14px 28px;
            border-radius:10px;
            border:none;
            background:var(--danger);
            color:white;
            font-size:clamp(14px,2.4vw,18px);
            cursor:pointer;
            margin-top:18px;
        }

        .episode-text{ font-size:clamp(16px,3vw,20px); color:var(--text); margin-bottom:12px; }
        .click-guide{ font-size:clamp(12px,2vw,14px); color:var(--muted); margin-top:10px; }

        .warning-text{ font-size:clamp(18px,3.6vw,26px); color:var(--danger); font-weight:800; margin-bottom:16px; }

        /* ì§„ë™ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shaking{ animation:shake .1s infinite; }

        /* ì‘ì€ í™”ë©´ì—ì„œ ë””ìì¸ ê°„ê²© ë³´ì • */
        @media (max-height:700px){
            #game-container{ min-height:520px; }
            #alien-character{ margin:6px 0; }
        }
    </style>
</head>
<body>
    <div id="game-container">

        <!-- ìŠ¤íƒ¯ ë°” -->
        <div id="stats-bar">
            <div class="stat">
                <div class="stat-name">ì˜ì–‘</div>
                <div class="stat-bar-container"><div id="nutrition-bar" class="stat-bar" style="width:100%"></div></div>
            </div>
            <div class="stat">
                <div class="stat-name">ì²´ë ¥</div>
                <div class="stat-bar-container"><div id="stamina-bar" class="stat-bar" style="width:100%"></div></div>
            </div>
            <div class="stat">
                <div class="stat-name">ì§€ì‹</div>
                <div class="stat-bar-container"><div id="knowledge-bar" class="stat-bar" style="width:100%"></div></div>
            </div>
        </div>

        <!-- ì¤‘ì•™ ìºë¦­í„° ì˜ì—­ (í•­ìƒ ì˜¤ë²„ë ˆì´ë³´ë‹¤ ìœ„ì— ìœ„ì¹˜) -->
        <div id="character-area">
            <div id="current-message"></div>
            <div id="alien-character" role="button" aria-label="ì•Œ/ì™¸ê³„ì¸"></div>
            <div id="click-counter"></div>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div id="action-buttons" style="display:none;">
            <button id="feed-button" class="action-button">ğŸš ë°¥ ì£¼ê¸°</button>
            <button id="play-button" class="action-button">ğŸƒ ë†€ì•„ì£¼ê¸°</button>
            <button id="study-button" class="action-button">ğŸ“š ê³µë¶€í•˜ê¸°</button>
        </div>

        <!-- ì˜¤ë²„ë ˆì´: ì‹œì‘ -->
        <div id="start-screen" class="overlay">
            <span style="font-size:64px;">ğŸ›¸</span>
            <h1>ì™¸ê³„ì¸ í‚¤ìš°ê¸°</h1>
            <button id="start-game-button" class="start-button" style="display:none;">ê²Œì„ Start</button>
            <div class="click-guide">í™”ë©´ì˜ ë¹ˆ ê³µê°„(ê²€ì€ ë°°ê²½)ì„ íƒ­í•˜ë©´ ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.</div>
        </div>

        <!-- ì˜¤ë²„ë ˆì´: ì—í”¼ì†Œë“œ / ë¶€í™” -->
        <div id="episode-screen" class="overlay" style="display:none;">
            <div id="ep-text" class="episode-text"></div>
            <div id="ep-warning" class="warning-text" style="display:none;"></div>
            <div id="ep-egg-click-counter" class="click-guide" style="font-size:1.1em;"></div>
            <div class="click-guide">í™”ë©´ì˜ ë¹ˆ ê³µê°„(ê²€ì€ ë°°ê²½)ì„ íƒ­í•˜ë©´ ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.</div>
        </div>

        <!-- ì˜¤ë²„ë ˆì´: ê²Œì„ì˜¤ë²„ -->
        <div id="game-over-screen" class="overlay" style="display:none;">
            <span style="font-size:64px;">ğŸ’€</span>
            <h2 style="margin:10px 0">ì™¸ê³„ì¸ ì‚¬ë§...</h2>
            <p id="death-reason" class="episode-text" style="font-size:1.1em"></p>
            <button id="restart-button" class="start-button" style="background-color:var(--danger);">ë‹¤ì‹œ ì‹œì‘</button>
        </div>

        <!-- ì˜¤ë²„ë ˆì´: ì—”ë”© -->
        <div id="ending-screen" class="overlay" style="display:none;">
            <span style="font-size:64px;">!ì¶•!</span>
            <h2 id="ending-message" class="episode-text"></h2>
            <div class="click-guide">í™”ë©´ì˜ ë¹ˆ ê³µê°„(ê²€ì€ ë°°ê²½)ì„ íƒ­í•˜ë©´ ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.</div>
        </div>
    </div>

<script>
    // --- DOM ---
    const startScreen = document.getElementById('start-screen');
    const episodeScreen = document.getElementById('episode-screen');
    const epText = document.getElementById('ep-text');
    const epWarning = document.getElementById('ep-warning');
    const epEggClickCounter = document.getElementById('ep-egg-click-counter');

    const alienCharacter = document.getElementById('alien-character');
    const currentMessage = document.getElementById('current-message');
    const clickCounter = document.getElementById('click-counter');
    const actionButtons = document.getElementById('action-buttons');

    const gameOverScreen = document.getElementById('game-over-screen');
    const deathReason = document.getElementById('death-reason');
    const restartButton = document.getElementById('restart-button');

    const endingScreen = document.getElementById('ending-screen');
    const endingMessage = document.getElementById('ending-message');

    const nutritionBar = document.getElementById('nutrition-bar');
    const staminaBar = document.getElementById('stamina-bar');
    const knowledgeBar = document.getElementById('knowledge-bar');

    const feedButton = document.getElementById('feed-button');
    const playButton = document.getElementById('play-button');
    const studyButton = document.getElementById('study-button');

    // --- ìƒíƒœ ---
    let gameState = 'start'; // start, episode, hatching, playing, evolving, dead, ending, ending-init
    let stats = { nutrition:100, stamina:100, knowledge:100 };
    let depletionInterval = null;
    let episodeStep = 0;
    let eggClicks = 0;
    let evolutionStage = 1;
    let isEvolutionInProgress = false;

    const MAX_STAT = 100;
    const DEPLETION_RATE = 9;
    const DEPLETION_INTERVAL_MS = 50;
    const DEPLETION_AMOUNT_PER_TICK = (DEPLETION_RATE * 0.1) / 3;
    const EVOLUTION_TIME_SEC = 20;
    const EVOLUTION_CLICK_COUNT = 30;
    const HATCHING_TIME_SEC = 10;
    const HATCHING_MIN_CLICKS = 30;

    // --- ìœ í‹¸: stat bar ì—…ë°ì´íŠ¸ ---
    function updateStatBar(statName, value){
        const bar = document.getElementById(`${statName}-bar`);
        bar.style.width = `${value}%`;
        if(value < 30) bar.style.backgroundColor = '#e74c3c';
        else if(value < 60) bar.style.backgroundColor = '#f39c12';
        else {
            if(statName === 'nutrition') bar.style.backgroundColor = '#2ecc71';
            else if(statName === 'stamina') bar.style.backgroundColor = '#3498db';
            else if(statName === 'knowledge') bar.style.backgroundColor = '#f1c40f';
        }
    }

    function depleteStats(){
        let deadStats = 0;
        for(const s in stats){
            stats[s] = Math.max(0, stats[s] - DEPLETION_AMOUNT_PER_TICK);
            updateStatBar(s, Math.round(stats[s]));
            if(stats[s] === 0) deadStats++;
        }
        if(deadStats >= 2 && gameState !== 'dead' && gameState !== 'ending-init'){
            let reason = '';
            if(stats.nutrition === 0 && stats.stamina === 0) reason = 'ì˜ì–‘ ë¶€ì¡±ê³¼ ì²´ë ¥ ê³ ê°ˆë¡œ í˜ì„ ìƒì—ˆìŠµë‹ˆë‹¤.';
            else if(stats.nutrition === 0 && stats.knowledge === 0) reason = 'ì˜ì–‘ ë¶€ì¡±ê³¼ ì§€ì‹ ë¶€ì¡±ìœ¼ë¡œ ìƒëª…ì„ ìœ ì§€í•  ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.';
            else if(stats.stamina === 0 && stats.knowledge === 0) reason = 'ì²´ë ¥ ê³ ê°ˆê³¼ ì§€ì‹ ë¶€ì¡±ìœ¼ë¡œ ë²„í‹¸ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.';
            endGame(reason);
        }
    }

    // --- ê²Œì„ ì‹œì‘ ---
    function startGameplay(){
        gameState = 'playing';
        alienCharacter.textContent = 'ğŸ‘¾';
        alienCharacter.style.display = 'block';
        currentMessage.textContent = 'ì™¸ê³„ì¸ì„ ê±´ê°•í•˜ê²Œ í‚¤ì›Œì£¼ì„¸ìš”!';
        actionButtons.style.display = 'flex';
        // ìŠ¤íƒ¯ ê°ì†Œ ì‹œì‘
        depletionInterval = setInterval(depleteStats, DEPLETION_INTERVAL_MS);
        // ì¼ì •ì‹œê°„ í›„ ì§„í™”
        setTimeout(startEvolution, EVOLUTION_TIME_SEC * 1000);
    }

    function endGame(reason){
        if(gameState === 'dead') return;
        gameState = 'dead';
        clearInterval(depletionInterval);
        alienCharacter.textContent = 'ğŸ’€';
        alienCharacter.style.cursor = 'default';
        actionButtons.style.display = 'none';
        deathReason.textContent = `[ì‚¬ë§ ì›ì¸]: ${reason}`;
        gameOverScreen.style.display = 'flex';
    }

    // --- ì—í”¼ì†Œë“œ/ë¶€í™” ë¡œì§ ---
    function handleScreenClick(){
        // í™”ë©´ í´ë¦­(ë°°ê²½)ì„ í†µí•´ ë‹¤ìŒ ìŠ¤í…ìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” í•¨ìˆ˜
        if(gameState === 'hatching' || gameState === 'dead' || gameState === 'pre-hatching') return;
        episodeStep++;

        if(episodeStep === 1){
            epText.textContent = "ì–´ëŠë‚  í•˜ëŠ˜ì—ì„œ ìˆ˜ìƒí•œ ì•Œì´ ë–¨ì–´ì¡Œë‹¤.";
        } else if(episodeStep === 2){
            // ë¶€í™” ì‹œì‘
            gameState = 'hatching';
            epText.style.display = 'none';
            epWarning.style.display = 'block';
            epWarning.textContent = "ìµœëŒ€í•œ ë¹ ë¥´ê²Œ í´ë¦­í•˜ì—¬ ì•Œì„ ë¶€í™”ì‹œí‚¤ì„¸ìš”!";

            // ì•Œ ë³´ì´ê¸°
            alienCharacter.textContent = 'ğŸ¥š';
            alienCharacter.style.display = 'block';
            alienCharacter.style.cursor = 'pointer';

            // ì—í”¼ì†Œë“œ ì˜¤ë²„ë ˆì´ëŠ” ë°±ê·¸ë¼ìš´ë“œ í´ë¦­ë§Œ ë°›ë„ë¡, ì•Œì€ ìœ„ë¡œ ë³´ì´ê²Œ z-index ìœ ì§€
            // (ìš°ë¦¬ëŠ” episodeScreen í´ë¦­ í•¸ë“¤ëŸ¬ì—ì„œ event.target ì²´í¬ë¡œ ë°°ê²½ í´ë¦­ë§Œ í—ˆìš©í•¨)

            // ì•Œ í´ë¦­ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (touch í¬í•¨)
            alienCharacter.removeEventListener('click', handleEggClick);
            alienCharacter.addEventListener('click', handleEggClick);
            alienCharacter.removeEventListener('touchstart', handleEggClick);
            alienCharacter.addEventListener('touchstart', handleEggClick, {passive:true});

            eggClicks = 0;
            let hatchTimeLeft = HATCHING_TIME_SEC;
            epEggClickCounter.textContent = `ë‚¨ì€ ì‹œê°„: ${hatchTimeLeft}ì´ˆ / í˜„ì¬ í„°ì¹˜ íšŸìˆ˜: ${eggClicks}íšŒ`;

            const hatchTimer = setInterval(() => {
                hatchTimeLeft--;
                epEggClickCounter.textContent = `ë‚¨ì€ ì‹œê°„: ${hatchTimeLeft}ì´ˆ / í˜„ì¬ í„°ì¹˜ íšŸìˆ˜: ${eggClicks}íšŒ`;

                if(hatchTimeLeft <= 0){
                    clearInterval(hatchTimer);
                    alienCharacter.removeEventListener('click', handleEggClick);
                    alienCharacter.removeEventListener('touchstart', handleEggClick);

                    if(eggClicks < HATCHING_MIN_CLICKS){
                        // ë¶€í™” ì‹¤íŒ¨
                        epText.style.display = 'block';
                        epText.textContent = `ğŸš¨ ì•Œì´ ê¹¨ì–´ë‚˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í„°ì¹˜ íšŸìˆ˜ ${eggClicks}íšŒ.`;
                        epWarning.style.display = 'none';
                        epEggClickCounter.textContent = '';
                        setTimeout(()=> endGame(`ë¶€í™” ì‹¤íŒ¨: ì•Œì„ ${HATCHING_MIN_CLICKS}íšŒ ë¯¸ë§Œ(${eggClicks}íšŒ)ìœ¼ë¡œ í„°ì¹˜í–ˆìŠµë‹ˆë‹¤.`), 1200);
                    } else {
                        // ë¶€í™” ì„±ê³µ
                        epText.style.display = 'block';
                        epText.textContent = `âœ¨ ì•Œì´ ë¶€í™”ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤! âœ¨`;
                        alienCharacter.textContent = 'ğŸ‘½';
                        epWarning.style.display = 'none';
                        epEggClickCounter.textContent = '';
                        gameState = 'episode';
                        episodeStep = 3;
                    }
                }
            },1000);

            return; // ë¶€í™”ìƒíƒœ ì§„ì… ì‹œ, ë°°ê²½ í´ë¦­ìœ¼ë¡œ ì¸í•œ ë‹¤ìŒ ìŠ¤í… ì§„í–‰ ë°©ì§€
        } else if(episodeStep === 3){
            epText.textContent = "ì™¸ê³„ì¸ì˜ ì •ì²´ê°€ ì•Œê³  ì‹¶ë‹¤ë©´ ëê¹Œì§€ í‚¤ì›Œì£¼ì„¸ìš”!";
        } else if(episodeStep === 4){
            // ê²Œì„ ì‹œì‘
            episodeScreen.style.display = 'none';
            epText.style.display = 'none';
            alienCharacter.style.fontSize = ''; // ê¸°ë³¸ í¬ê¸°
            startGameplay();
        }
    }

    function handleEggClick(e){
        // ëª¨ë°”ì¼ í„°ì¹˜/í´ë¦­ ë‘˜ ë‹¤ í—ˆìš©
        if(gameState !== 'hatching') return;
        // prevent the parent overlay from receiving this click as 'background' advance
        e.stopPropagation && e.stopPropagation();
        eggClicks++;
        epEggClickCounter.textContent = `í˜„ì¬ í„°ì¹˜ íšŸìˆ˜: ${eggClicks}íšŒ`;

        // ê°„ë‹¨í•œ í”¼ë“œë°± ì• ë‹ˆë©”ì´ì…˜
        alienCharacter.style.transform = 'scale(0.92)';
        setTimeout(()=> alienCharacter.style.transform = 'scale(1)', 90);
    }

    // --- ì•¡ì…˜ ë²„íŠ¼ ë¡œì§ ---
    function performAction(statName){
        if(gameState !== 'playing' && gameState !== 'evolving') return;
        stats[statName] = Math.min(MAX_STAT, stats[statName] + 30);
        updateStatBar(statName, stats[statName]);

        // ë²„íŠ¼ ì ê¸ˆ (ê°„ë‹¨)
        const map = { nutrition:feedButton, stamina:playButton, knowledge:studyButton };
        const btn = map[statName];
        if(btn){
            btn.disabled = true;
            setTimeout(()=> btn.disabled = false, 3000);
        }

        currentMessage.textContent = `${statName === 'nutrition' ? 'ğŸš ì˜ì–‘' : statName === 'stamina' ? 'ğŸƒ ì²´ë ¥' : 'ğŸ“š ì§€ì‹'} íšŒë³µ!`;
    }

    feedButton.addEventListener('click', ()=>performAction('nutrition'));
    playButton.addEventListener('click', ()=>performAction('stamina'));
    studyButton.addEventListener('click', ()=>performAction('knowledge'));
    // touch support for buttons
    ['touchstart'].forEach(evt => {
        feedButton.addEventListener(evt, ()=>performAction('nutrition'), {passive:true});
        playButton.addEventListener(evt, ()=>performAction('stamina'), {passive:true});
        studyButton.addEventListener(evt, ()=>performAction('knowledge'), {passive:true});
    });

    // --- ì§„í™” ë° ì—”ë”© ë¡œì§ ---
    function startEvolution(){
        if(isEvolutionInProgress || gameState === 'dead') return;
        isEvolutionInProgress = true;
        gameState = 'evolving';
        clearInterval(depletionInterval);

        clickCounter.textContent = `í„°ì¹˜ íšŸìˆ˜: 0/${EVOLUTION_CLICK_COUNT}`;
        currentMessage.textContent = `âœ¨ ì§„í™” ì¤€ë¹„! ì™¸ê³„ì¸ì„ ${EVOLUTION_CLICK_COUNT}íšŒ í„°ì¹˜í•˜ì„¸ìš”!`;

        // ì§„í™” í´ë¦­ ë¦¬ìŠ¤ë„ˆ
        alienCharacter.removeEventListener('click', handleEvolutionClick);
        alienCharacter.addEventListener('click', handleEvolutionClick);
        alienCharacter.removeEventListener('touchstart', handleEvolutionClick);
        alienCharacter.addEventListener('touchstart', handleEvolutionClick, {passive:true});

        eggClicks = 0;
        // 20ì´ˆ í›„ ìµœì¢… ì—”ë”© ì¤€ë¹„
        setTimeout(startFinalEnding, EVOLUTION_TIME_SEC * 1000);
    }

    function handleEvolutionClick(e){
        if(gameState !== 'evolving') return;
        e.stopPropagation && e.stopPropagation();
        eggClicks++;
        clickCounter.textContent = `í„°ì¹˜ íšŸìˆ˜: ${eggClicks}/${EVOLUTION_CLICK_COUNT}`;

        alienCharacter.style.transform = 'scale(0.92)';
        setTimeout(()=> alienCharacter.style.transform = 'scale(1)', 90);

        if(eggClicks >= EVOLUTION_CLICK_COUNT){
            alienCharacter.removeEventListener('click', handleEvolutionClick);
            alienCharacter.removeEventListener('touchstart', handleEvolutionClick);
            evolveToNextStage();
        }
    }

    function evolveToNextStage(){
        evolutionStage = 2;
        gameState = 'playing';
        isEvolutionInProgress = false;

        alienCharacter.classList.add('evolution-2');
        currentMessage.textContent = 'ğŸ‰ 2ë‹¨ê³„ ì§„í™” ì„±ê³µ! ì™¸ê³„ì¸ì´ ë‘ ë°° ì»¤ì¡ŒìŠµë‹ˆë‹¤!';
        clickCounter.textContent = '';
        depletionInterval = setInterval(depleteStats, DEPLETION_INTERVAL_MS);
    }

    function startFinalEnding(){
        if(gameState === 'dead') return;
        clearInterval(depletionInterval);
        gameState = 'ending-init';
        currentMessage.textContent = 'âœ¨ ì™¸ê³„ì¸ì´ ë§ˆì§€ë§‰ ì§„í™”ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤...';
        alienCharacter.classList.add('shaking');
        actionButtons.style.display = 'none';

        setTimeout(()=>{
            alienCharacter.classList.remove('shaking');
            showEndingEpisode(1);
        }, 5000);
    }

    function showEndingEpisode(step){
        const endingTexts = [
            "ì¶•! ì™¸ê³„ì¸ ì„±ì¥ ì™„ë£Œ",
            "ì™¸ê³„ì¸ì˜ ì •ì²´ëŠ” ë°”ë¡œ..",
            "ì™¸ê³„ì¸ì´ì˜€ìŠµë‹ˆë‹¤.. ê°ì‚¬í•©ë‹ˆë‹¤.. ğŸ‘½"
        ];
        if(step >=1 && step <=3){
            alienCharacter.style.display = 'none';
            endingScreen.style.display = 'flex';
            endingMessage.textContent = endingTexts[step-1];

            if(step < 3){
                // background í´ë¦­ìœ¼ë¡œ ë„˜ì–´ê°€ë„ë¡ (episodeScreenê³¼ ë™ì¼ ë°©ì‹)
                endingScreen.onclick = (e) => {
                    // ë°°ê²½ ì˜ì—­ í´ë¦­ë§Œ ì¸ì • (ë¹ˆ ê³µê°„)
                    if(e.target !== endingScreen) return;
                    endingScreen.style.display = 'none';
                    if(step+1 <= 3) showEndingEpisode(step+1);
                };
            } else {
                endingScreen.onclick = null;
            }
        }
    }

    // --- ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”© ---
    function initializeGame(){
        // ì´ˆê¸° UI
        document.getElementById('episode-screen').style.display = 'none';
        gameOverScreen.style.display = 'none';
        endingScreen.style.display = 'none';

        alienCharacter.style.display = 'none';
        actionButtons.style.display = 'none';

        updateStatBar('nutrition',100);
        updateStatBar('stamina',100);
        updateStatBar('knowledge',100);

        // startScreen: ë°°ê²½ í´ë¦­ë§Œ ë°˜ì‘
        function startBackgroundClick(e){
            if(e.target !== startScreen) return;
            showEpisodeScreen();
        }
        startScreen.addEventListener('click', startBackgroundClick);
        startScreen.addEventListener('touchstart', (e)=> { if(e.target === startScreen) { e.preventDefault(); showEpisodeScreen(); } }, {passive:false});

        // episodeScreen: ë°°ê²½ í´ë¦­ë§Œ ë°˜ì‘
        function episodeBackgroundClick(e){
            if(e.target !== episodeScreen) return;
            handleScreenClick();
        }
        episodeScreen.addEventListener('click', episodeBackgroundClick);
        episodeScreen.addEventListener('touchstart', (e)=> { if(e.target === episodeScreen) { e.preventDefault(); handleScreenClick(); } }, {passive:false});

        // restart
        restartButton.addEventListener('click', ()=> location.reload());
        restartButton.addEventListener('touchstart', ()=> location.reload(), {passive:true});
    }

    function showEpisodeScreen(){
        if(gameState !== 'start') return;
        gameState = 'episode';
        startScreen.style.display = 'none';
        episodeScreen.style.display = 'flex';

        epText.textContent = "ì–´ëŠë‚  í•˜ëŠ˜ì—ì„œ ìˆ˜ìƒí•œ ì•Œì´ ë–¨ì–´ì¡Œë‹¤.";
        epText.style.display = 'block';
        epWarning.style.display = 'none';
        episodeStep = 1;
    }

    // --- ì‹œì‘ ---
    initializeGame();
</script>
</body>
</html>
